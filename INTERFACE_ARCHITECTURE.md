# Архитектура интерфейсов Car Rental Manager

## Обзор

Система имеет **три отдельных интерфейса** с разными точками входа:

1. **INVESTOR** - Интерфейс для инвесторов
2. **RENTAL** - Интерфейс для прокатчиков (директора, менеджеры)
3. **AGENT** - Интерфейс для агентов

## Типы интерфейсов

### 1. Интерфейс инвестора (INVESTOR)

**Цель**: Просмотр финансовой статистики и отчетности

**Возможности**:
- Просмотр доходности инвестиций
- Статистика по компаниям
- Финансовые отчеты и аналитика
- Информация о состоянии автомобилей
- История платежей и доходов

**Точка входа**: `InvestorMainScreen`

**Цветовая тема**: Зеленый (#4CAF50)

**Иконка**: `Icons.account_balance`

---

### 2. Интерфейс прокатчика (RENTAL)

**Цель**: Управление прокатным бизнесом

**Кто использует**: Директора, менеджеры, владельцы

**Условие доступа**: ⚠️ **Пользователь ДОЛЖЕН быть привязан к компании** в роли OWNER, DIRECTOR или MANAGER.

**Что происходит при отсутствии привязки**:
- Пользователь видит экран "Доступ запрещен"
- Объяснение требуемых ролей
- Предложение переключиться на интерфейс AGENT или INVESTOR
- Возможность выйти из системы
- *(В будущем)* Предложение выбрать компанию

**Возможности**:
- Управление компанией
- Автопарк и автомобили
- Мгновенные бронирования
- Утверждение заявок от агентов
- Управление клиентами
- Управление командой
- Финансовые операции
- Отчеты и аналитика

**Точка входа**: `RentalMainScreen`

**Цветовая тема**: Синий (#2196F3)

**Иконка**: `Icons.car_rental`

---

### 3. Интерфейс агента (AGENT)

**Цель**: Создание заявок на бронирование

**Кто использует**: Агенты

**Условие доступа**: Открыт для всех авторизованных пользователей

**Возможности**:
- Создание заявок на бронирование (требуют утверждения)
- Просмотр статусов заявок
- Выбор одобренной заявки для подтверждения
- Работа с клиентами
- История заявок

**Точка входа**: `AgentMainScreen`

**Цветовая тема**: Оранжевый (#FF9800)

**Иконка**: `Icons.support_agent`

---

## Поток навигации

```
Запуск приложения
    ↓
AuthWrapper (проверка авторизации)
    ↓
┌─────────────────┐
│ Авторизован?    │
└─────────────────┘
    │
    ├─ НЕТ → RoleSelectionScreen (выбор типа интерфейса)
    │            ↓
    │        LoginScreen (с выбранным типом)
    │            ↓
    │        Авторизация
    │            ↓
    │        Сохранение выбранного типа в SharedPreferences
    │            ↓
    └─ ДА ──────┴─→ Загрузка сохраненного типа интерфейса
                    ↓
                ┌───┴───┐
                │ Тип?  │
                └───┬───┘
                    │
                    ├─ INVESTOR → InvestorMainScreen ✅
                    │
                    ├─ AGENT    → AgentMainScreen ✅
                    │
                    └─ RENTAL   → RentalMainScreen
                                     ↓
                                ┌────────────────┐
                                │ Привязан к     │
                                │ компании?      │
                                │ (OWNER/        │
                                │  DIRECTOR/     │
                                │  MANAGER)      │
                                └────────────────┘
                                     │
                                     ├─ ДА  → Основной интерфейс ✅
                                     │
                                     └─ НЕТ → Экран "Доступ запрещен" ⛔
                                              ├─ Переключиться на AGENT
                                              ├─ Переключиться на INVESTOR
                                              ├─ (Позже) Выбрать компанию
                                              └─ Выйти
```

## Техническая реализация

### Файлы и компоненты

#### Экраны авторизации

**`lib/screens/auth/role_selection_screen.dart`**
- Экран выбора типа интерфейса
- Три карточки: Инвестор, Гость, Пользователь
- Навигация на LoginScreen с выбранным типом

**`lib/screens/auth/login_screen.dart`**
- Принимает параметр `interfaceType: InterfaceType`
- Адаптирует UI (цвет, иконка, заголовок) под тип интерфейса
- Сохраняет выбранный тип в `InterfaceService` после успешного входа

#### Главные экраны

**`lib/screens/main/investor_main_screen.dart`**
- Интерфейс для инвесторов
- Зеленая цветовая схема

**`lib/screens/main/rental_main_screen.dart`**
- Интерфейс для прокатчиков (директора, менеджеры)
- Проверка привязки к компании
- Синяя цветовая схема

**`lib/screens/main/agent_main_screen.dart`**
- Интерфейс для агентов
- Оранжевая цветовая схема

#### Сервисы

**`lib/services/interface_service.dart`**
- Сохранение выбранного типа интерфейса в SharedPreferences
- Методы:
  - `saveInterfaceType(InterfaceType)` - сохранить тип
  - `getInterfaceType()` - получить сохраненный тип
  - `clearInterfaceType()` - очистить (при выходе)

#### Обертки

**`lib/widgets/auth_wrapper.dart`**
- Основная обертка приложения
- Проверяет авторизацию через `AuthService`
- При авторизации загружает сохраненный тип интерфейса
- Перенаправляет на соответствующий экран

### Модели данных

**`InterfaceType` enum**:
```dart
enum InterfaceType {
  investor,  // Интерфейс для инвесторов
  rental,    // Интерфейс для прокатчиков (директора, менеджеры)
  agent,     // Интерфейс для агентов
}
```

**`RoleType` enum**:
```dart
enum RoleType {
  owner,     // Владелец гаража/компании
  director,  // Директор компании
  manager,   // Менеджер (привязан к компании)
  agent,     // Агент (создает заявки)
}
```

**Важно**: Роль GUEST удалена. Вместо нее используется роль AGENT.

### Зависимости

- `shared_preferences: ^2.3.3` - для сохранения выбранного интерфейса локально

## Сценарии использования

### Первый вход

1. Пользователь запускает приложение
2. Видит экран выбора роли (`RoleSelectionScreen`)
3. Выбирает тип интерфейса (Инвестор/Прокатчик/Агент)
4. Переходит на экран входа с соответствующей темой
5. Вводит логин и пароль
6. Система сохраняет выбранный тип интерфейса
7. Пользователь попадает на соответствующий главный экран

### Повторный вход

1. Пользователь запускает приложение
2. Система проверяет авторизацию
3. Загружает сохраненный тип интерфейса
4. Автоматически открывает соответствующий главный экран
5. Пользователь попадает туда же, где был в прошлый раз

### Выход из системы

1. Пользователь нажимает кнопку "Выйти"
2. `AuthService.signOut()` очищает:
   - Firebase Auth сессию
   - Сохраненный тип интерфейса (через `InterfaceService`)
3. AuthWrapper автоматически показывает `RoleSelectionScreen`

### Смена типа интерфейса

Чтобы сменить тип интерфейса, пользователь должен:
1. Выйти из системы
2. Войти заново, выбрав другой тип интерфейса

### Отсутствие доступа к интерфейсу RENTAL

**Сценарий**: Пользователь выбрал интерфейс "Прокатчик", но не привязан к компании.

1. Пользователь авторизуется и выбирает интерфейс RENTAL
2. `RentalMainScreen` проверяет наличие активных ролей через `UserRoleService.getUserRoles()`
3. Фильтрует роли: только OWNER, DIRECTOR или MANAGER, привязанные к компании
4. Если найдены подходящие роли — показывается основной интерфейс
5. Если ролей нет — показывается экран "Доступ запрещен" с:
   - Объяснением требуемых ролей
   - Кнопками переключения на AGENT или INVESTOR
   - Кнопкой выхода из системы
   - *(В будущем)* Предложением выбрать компанию
6. При переключении интерфейса:
   - Сохраняется новый тип через `InterfaceService.saveInterfaceType()`
   - Приложение перезагружается с новым интерфейсом

**Важно**: 
- Менеджеры **ОБЯЗАТЕЛЬНО** должны быть привязаны к компании
- Привязка к гаражу не обязательна
- Без привязки к компании доступны только интерфейсы AGENT или INVESTOR

## Преимущества архитектуры

1. **Разделение интерфейсов** - каждая категория пользователей видит только нужные функции
2. **Упрощение UX** - нет необходимости скрывать функции через права доступа
3. **Независимая разработка** - можно разрабатывать каждый интерфейс отдельно
4. **Производительность** - загружается только нужный код
5. **Персонализация** - каждый интерфейс может иметь свой дизайн
6. **Безопасность** - меньше риск случайного доступа к чужим функциям

## Дальнейшая разработка

### Инвестор

- [ ] Дашборд с ключевыми метриками
- [ ] График доходности
- [ ] Список автомобилей с детальной статистикой
- [ ] История выплат
- [ ] Документы и договоры

### Прокатчик

- [ ] Дашборд с общей статистикой
- [ ] Управление автопарком
- [ ] Список бронирований и заявок
- [ ] Утверждение заявок от агентов
- [ ] Управление клиентами
- [ ] Управление командой
- [ ] Финансовые отчеты
- [ ] Настройки компании
- [ ] **Выбор компании при отсутствии привязки**

### Агент

- [ ] Форма создания множественных заявок
- [ ] Список всех моих заявок (все статусы)
- [ ] Выбор одобренной заявки для подтверждения
- [ ] Работа с клиентами
- [ ] История заявок

## Связь с контекстными ролями

Важно понимать различие:

- **InterfaceType** - определяет, КАКОЙ интерфейс видит пользователь
- **RoleType** (OWNER, DIRECTOR, MANAGER, AGENT) - определяет ПРАВА пользователя в конкретном контексте (компания/гараж)

Один пользователь может:
- Быть **OWNER** в одной компании (интерфейс RENTAL)
- Быть **MANAGER** в другой компании (интерфейс RENTAL)
- Работать как **AGENT** (интерфейс AGENT)
- Инвестировать в автомобили (интерфейс INVESTOR)

При входе пользователь выбирает, в каком качестве он хочет работать.

### Удаленная роль GUEST

Роль GUEST была удалена из системы. Вместо нее используется роль AGENT:
- Агенты могут создавать заявки на бронирование (требуют утверждения)
- Для мгновенного бронирования нужна роль MANAGER или выше, привязанная к компании
