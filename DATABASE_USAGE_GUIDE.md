# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Car Rental Manager

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥–µ–ª–∏-–¥–∞–Ω–Ω—ã—Ö)
3. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
4. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø—Ä–∞–≤–∞–º–∏-–¥–æ—Å—Ç—É–ø–∞)
5. [–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö](#–º–∏–≥—Ä–∞—Ü–∏—è-—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö-–¥–∞–Ω–Ω—ã—Ö)

---

## üèó –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –ü—Ä–∏–Ω—Ü–∏–ø "–û–¥–∏–Ω –∞–∫—Ç–∏–≤ ‚Äî –¥–≤–∞ —Å—É–±—ä–µ–∫—Ç–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏"

–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ **–≤–ª–∞–¥–µ–Ω–∏—è** –∏ **—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏:

- **–í–ª–∞–¥–µ–ª–µ—Ü (Investor)** - —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
- **–£–ø—Ä–∞–≤–ª—è—é—â–∏–π (Manager/Director)** - –∫—Ç–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–ø–∞—Ä–∫–æ–º –∏ —Å–¥–∞–µ—Ç –≤ –∞—Ä–µ–Ω–¥—É

### –¢–∏–ø—ã –≥–∞—Ä–∞–∂–µ–π

1. **Personal Garage** - –ª–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂ –≤–ª–∞–¥–µ–ª—å—Ü–∞-–∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ (INVESTOR)
   - –í–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–≤—Ç–æ
   - –ú–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Ö–æ–¥ –∑–∞ –≤—ã—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏

2. **Company Garage** - –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –≥–∞—Ä–∞–∂ –∫–æ–º–ø–∞–Ω–∏–∏
   - –ö–æ–º–ø–∞–Ω–∏—è –≤–ª–∞–¥–µ–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏
   - DIRECTOR —É–ø—Ä–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–ø–∞—Ä–∫–æ–º
   - –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

---

## üì¶ –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. User (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

```dart
class AppUser {
  final String uid;
  final String email;
  final String displayName;
  final GlobalRole globalRole;  // DIRECTOR, MANAGER, INVESTOR, GUEST
  final List<String> organizations;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

**–†–æ–ª–∏:**
- `DIRECTOR` - –£–ø—Ä–∞–≤–ª—è—é—â–∏–π –∞–≤—Ç–æ–ø–∞—Ä–∫–æ–º
- `MANAGER` - –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
- `INVESTOR` - –í–ª–∞–¥–µ–ª–µ—Ü-–∏–Ω–≤–µ—Å—Ç–æ—Ä
- `GUEST` - –ì–æ—Å—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

### 2. Garage (–ì–∞—Ä–∞–∂)

```dart
// –õ–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂ (–ª—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
class PersonalGarage extends Garage {
  final String ownerId;              // USER_id –≤–ª–∞–¥–µ–ª—å—Ü–∞ (INVESTOR, DIRECTOR, MANAGER, GUEST)
  final String? managingCompanyId;   // COMPANY_id —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
  final double commissionRate;       // –ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏
}

// –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –≥–∞—Ä–∞–∂ (—Ç–æ–ª—å–∫–æ –∫–æ–º–ø–∞–Ω–∏–∏)
class CompanyGarage extends Garage {
  final String companyId;            // COMPANY_id –≤–ª–∞–¥–µ—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
  final String directorId;           // USER_id –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞
}
```

**–í–∞–∂–Ω–æ:**
- **–õ—é–±–æ–π USER** –º–æ–∂–µ—Ç –∏–º–µ—Ç—å PersonalGarage (INVESTOR, DIRECTOR, MANAGER, GUEST)
- INVESTOR - –≤–ª–∞–¥–µ–ª–µ—Ü-–∏–Ω–≤–µ—Å—Ç–æ—Ä, –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
- DIRECTOR - –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ª–∏—á–Ω—ã–µ –∞–≤—Ç–æ –ø–æ–º–∏–º–æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö
- MANAGER - –º–æ–∂–µ—Ç –≤–ª–∞–¥–µ—Ç—å –∞–≤—Ç–æ, –Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–æ–º–ø–∞–Ω–∏—é
- GUEST - –º–æ–∂–µ—Ç –≤–ª–∞–¥–µ—Ç—å –∞–≤—Ç–æ, –Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

### 3. Car (–ê–≤—Ç–æ–º–æ–±–∏–ª—å)

```dart
class Car {
  // –í–ª–∞–¥–µ–Ω–∏–µ (–û–î–ò–ù –≥–∞—Ä–∞–∂ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å)
  final String ownerId;        // USER_id –≤–ª–∞–¥–µ–ª—å—Ü–∞
  final String garageId;       // ID –≥–∞—Ä–∞–∂–∞ (–¢–û–õ–¨–ö–û –û–î–ò–ù)
  final GarageType garageType; // PERSONAL –∏–ª–∏ COMPANY
  
  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  final String? companyId;     // COMPANY_id —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
  
  // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  final String make;
  final String model;
  final String licensePlate;
  final CarStatus status;
  final double dailyRate;
  final double monthlyRate;
  // ...
}
```

**–í–∞–∂–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**
- ‚ö†Ô∏è **–ö–∞–∂–¥—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¢–û–õ–¨–ö–û –û–î–ù–û–ú–£ –≥–∞—Ä–∞–∂—É**
- –õ–∏–±–æ `personal_garage_XXX` (–ª–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –õ–∏–±–æ `COMPANY_garage_XXX` (–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –≥–∞—Ä–∞–∂ –∫–æ–º–ø–∞–Ω–∏–∏)
- –°–º–µ–Ω–∞ –≥–∞—Ä–∞–∂–∞ = –ø–µ—Ä–µ–¥–∞—á–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –¥—Ä—É–≥–æ–º—É –≤–ª–∞–¥–µ–ª—å—Ü—É/–∫–æ–º–ø–∞–Ω–∏–∏

### 4. CarPermissions (–ü—Ä–∞–≤–∞ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å)

```dart
class CarPermissions {
  final String userId;
  final String carId;
  final bool canView;
  final bool canEdit;
  final bool canBook;
  final bool canConfirmBooking;
  final bool canViewFinancials;
  final DateTime grantedAt;
  final String grantedBy;
}
```

### 5. Rental (–ê—Ä–µ–Ω–¥–∞)

```dart
class Rental {
  final String carId;
  final String clientId;
  final String rentalUserId;         // –°–æ–∑–¥–∞—Ç–µ–ª—å –±—Ä–æ–Ω–∏
  final String carOwnerId;           // –í–ª–∞–¥–µ–ª–µ—Ü –∞–≤—Ç–æ
  final String? managingCompanyId;   // –£–ø—Ä–∞–≤–ª—è—é—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è
  
  // –§–∏–Ω–∞–Ω—Å—ã
  final double priceAmount;          // –°—É–º–º–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
  final double commissionAmount;     // –ö–æ–º–∏—Å—Å–∏—è
  final double depositAmount;        // –ó–∞–ª–æ–≥
  final double ownerEarnings;        // –ü—Ä–∏–±—ã–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞
  
  final RentalStatus status;
  // ...
}
```

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ –≥–∞—Ä–∞–∂–∞ (–¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

```dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:car_rental_manager/models/models.dart';

Future<void> createPersonalGarage({
  required String ownerId,        // –õ—é–±–æ–π USER (INVESTOR, DIRECTOR, MANAGER, GUEST)
  required String name,
  String? managingCompanyId,
  double commissionRate = 0.0,
}) async {
  final garage = PersonalGarage(
    id: 'personal_garage_${DateTime.now().millisecondsSinceEpoch}',
    name: name,
    ownerId: ownerId,
    managingCompanyId: managingCompanyId,
    commissionRate: commissionRate,
    createdAt: DateTime.now(),
    updatedAt: DateTime.now(),
  );

  await FirebaseFirestore.instance
      .collection('garages')
      .doc(garage.id)
      .set(garage.toFirestore());
      
  print('–õ–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂ —Å–æ–∑–¥–∞–Ω: ${garage.id}');
}

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π:

// INVESTOR —Å–æ–∑–¥–∞–µ—Ç –ª–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂ —Å —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–µ–π
await createPersonalGarage(
  ownerId: investorUserId,
  name: '–ú–æ–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞–≤—Ç–æ–ø–∞—Ä–∫',
  managingCompanyId: 'ORG_123',
  commissionRate: 0.15,  // 15% –∫–æ–º–ø–∞–Ω–∏–∏
);

// DIRECTOR —Å–æ–∑–¥–∞–µ—Ç –ª–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂ (–ø–æ–º–∏–º–æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ)
await createPersonalGarage(
  ownerId: directorUserId,
  name: '–õ–∏—á–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏',
  managingCompanyId: null,  // –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∞–º
);

// MANAGER —Å–æ–∑–¥–∞–µ—Ç –ª–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂
await createPersonalGarage(
  ownerId: managerUserId,
  name: '–ú–æ–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏',
  managingCompanyId: 'ORG_456',  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ –∫–æ–º–ø–∞–Ω–∏—é
);
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –≥–∞—Ä–∞–∂–∞

```dart
Future<void> createCompanyGarage({
  required String companyId,
  required String directorId,
  required String name,
}) async {
  final garage = CompanyGarage(
    id: 'COMPANY_garage_${DateTime.now().millisecondsSinceEpoch}',
    name: name,
    companyId: companyId,
    directorId: directorId,
    createdAt: DateTime.now(),
    updatedAt: DateTime.now(),
  );

  await FirebaseFirestore.instance
      .collection('garages')
      .doc(garage.id)
      .set(garage.toFirestore());
      
  print('–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –≥–∞—Ä–∞–∂ —Å–æ–∑–¥–∞–Ω: ${garage.id}');
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –≤ –ª–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂

```dart
Future<void> addCarToPersonalGarage({
  required String ownerId,
  required String garageId,
  String? managingCompanyId,
  required String make,
  required String model,
  required String licensePlate,
  required double dailyRate,
  required double monthlyRate,
}) async {
  final car = Car(
    id: FirebaseFirestore.instance.collection('cars').doc().id,
    ownerId: ownerId,
    garageId: garageId,
    garageType: GarageType.personal,
    companyId: managingCompanyId,
    make: make,
    model: model,
    licensePlate: licensePlate,
    status: CarStatus.available,
    dailyRate: dailyRate,
    monthlyRate: monthlyRate,
    photosLinks: [],
    createdAt: DateTime.now(),
    updatedAt: DateTime.now(),
  );

  await FirebaseFirestore.instance
      .collection('cars')
      .doc(car.id)
      .set(car.toFirestore());
      
  print('–ê–≤—Ç–æ–º–æ–±–∏–ª—å –¥–æ–±–∞–≤–ª–µ–Ω: ${car.fullName}');
}
```

### –ü–µ—Ä–µ–¥–∞—á–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –≤ –¥—Ä—É–≥–æ–π –≥–∞—Ä–∞–∂

```dart
import 'package:car_rental_manager/services/car_service.dart';

final carService = CarService();

// –ü–µ—Ä–µ–¥–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏–∑ –ª–∏—á–Ω–æ–≥–æ –≥–∞—Ä–∞–∂–∞ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π
// –û–î–ò–ù –≥–∞—Ä–∞–∂ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –û–î–ò–ù –≥–∞—Ä–∞–∂
await carService.transferCarToGarage(
  carId: 'CAR_123',
  newOwnerId: 'COMPANY_456',              // –ù–æ–≤—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü
  newGarageId: 'COMPANY_garage_456',      // –ù–æ–≤—ã–π –≥–∞—Ä–∞–∂ (–û–î–ò–ù)
  newGarageType: 'COMPANY',
  newCompanyId: 'COMPANY_456',
  transferredBy: currentUserId,
);

// –ü–µ—Ä–µ–¥–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –≤ –ª–∏—á–Ω—ã–π –≥–∞—Ä–∞–∂
await carService.transferCarToGarage(
  carId: 'CAR_123',
  newOwnerId: 'USER_789',
  newGarageId: 'personal_garage_789',     // –î—Ä—É–≥–æ–π –û–î–ò–ù –≥–∞—Ä–∞–∂
  newGarageType: 'PERSONAL',
  newCompanyId: null,
  transferredBy: currentUserId,
);

// ‚ùå –ù–ï–õ–¨–ó–Ø: –ê–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –¥–≤—É—Ö –≥–∞—Ä–∞–∂–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
// –¢–æ–ª—å–∫–æ –û–î–ò–ù garageId –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≥–∞—Ä–∞–∂–∞

```dart
// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –û–î–ù–û–ì–û –≥–∞—Ä–∞–∂–∞
final personalCars = await carService.getCarsByGarage('personal_garage_123');
final companyCars = await carService.getCarsByGarage('COMPANY_garage_456');

// –ö–∞–∂–¥—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ –û–î–ò–ù garageId
for (final car in personalCars) {
  print('${car.make} ${car.model} –≤ –≥–∞—Ä–∞–∂–µ: ${car.garageId}');
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
  assert(car.validateGarageConsistency());
}
```

```dart
Future<void> addCarToCompanyGarage({
  required String companyId,
  required String garageId,
  required String make,
  required String model,
  required String licensePlate,
  required double dailyRate,
  required double monthlyRate,
}) async {
  // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
  final orgDoc = await FirebaseFirestore.instance
      .collection('organizations')
      .doc(companyId)
      .get();
  
  final directorId = orgDoc.data()?['director_user_id'];

  final car = Car(
    id: FirebaseFirestore.instance.collection('cars').doc().id,
    ownerId: companyId, // –í–ª–∞–¥–µ–ª–µ—Ü - –∫–æ–º–ø–∞–Ω–∏—è
    garageId: garageId,
    garageType: GarageType.company,
    companyId: companyId,
    make: make,
    model: model,
    licensePlate: licensePlate,
    status: CarStatus.available,
    dailyRate: dailyRate,
    monthlyRate: monthlyRate,
    photosLinks: [],
    createdAt: DateTime.now(),
    updatedAt: DateTime.now(),
  );

  await FirebaseFirestore.instance
      .collection('cars')
      .doc(car.id)
      .set(car.toFirestore());
}
```

### –í—ã–¥–∞—á–∞ –ø—Ä–∞–≤ –º–µ–Ω–µ–¥–∂–µ—Ä—É –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å

```dart
Future<void> grantCarPermissions({
  required String carId,
  required String managerId,
  required String grantedBy,
  bool canView = true,
  bool canEdit = false,
  bool canBook = false,
  bool canConfirmBooking = false,
  bool canViewFinancials = false,
}) async {
  final permission = CarPermissions(
    userId: managerId,
    carId: carId,
    canView: canView,
    canEdit: canEdit,
    canBook: canBook,
    canConfirmBooking: canConfirmBooking,
    canViewFinancials: canViewFinancials,
    grantedAt: DateTime.now(),
    grantedBy: grantedBy,
  );

  await FirebaseFirestore.instance
      .collection('cars')
      .doc(carId)
      .collection('permissions')
      .doc(managerId)
      .set(permission.toFirestore());
      
  print('–ü—Ä–∞–≤–∞ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤—ã–¥–∞–Ω—ã –º–µ–Ω–µ–¥–∂–µ—Ä—É: $managerId');
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ä–∞—Å—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏

```dart
Future<void> createRental({
  required String carId,
  required String clientId,
  required String rentalUserId,
  required DateTime startDate,
  required DateTime endDate,
  required double dailyRate,
  required double depositAmount,
  double commissionRate = 0.15, // 15% –∫–æ–º–∏—Å—Å–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
}) async {
  // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ
  final carDoc = await FirebaseFirestore.instance
      .collection('cars')
      .doc(carId)
      .get();
  
  final carData = carDoc.data()!;
  final carOwnerId = carData['owner_id'];
  final managingCompanyId = carData['company_id'];
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–Ω—Å—ã
  final days = endDate.difference(startDate).inDays + 1;
  final priceAmount = dailyRate * days;
  final commissionAmount = priceAmount * commissionRate;
  final ownerEarnings = priceAmount - commissionAmount;

  final rental = Rental(
    id: FirebaseFirestore.instance.collection('rentals').doc().id,
    carId: carId,
    clientId: clientId,
    rentalUserId: rentalUserId,
    carOwnerId: carOwnerId,
    managingCompanyId: managingCompanyId,
    startDate: startDate,
    endDate: endDate,
    status: RentalStatus.pending,
    priceAmount: priceAmount,
    commissionAmount: commissionAmount,
    depositAmount: depositAmount,
    ownerEarnings: ownerEarnings,
    createdAt: DateTime.now(),
    updatedAt: DateTime.now(),
  );

  await FirebaseFirestore.instance
      .collection('rentals')
      .doc(rental.id)
      .set(rental.toFirestore());
      
  print('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ: ${rental.id}');
  print('–°—É–º–º–∞: $priceAmount, –ö–æ–º–∏—Å—Å–∏—è: $commissionAmount, –í–ª–∞–¥–µ–ª—å—Ü—É: $ownerEarnings');
}
```

---

## üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AccessControl

```dart
import 'package:car_rental_manager/utils/access_control.dart';

final accessControl = AccessControl();

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—é
Future<void> checkCarAccess(String userId, Car car, GlobalRole userRole) async {
  final canView = await accessControl.canViewCar(userId, car);
  final canEdit = await accessControl.canEditCar(userId, car, userRole);
  final canDelete = await accessControl.canDeleteCar(userId, car, userRole);
  
  print('–ü—Ä–æ—Å–º–æ—Ç—Ä: $canView, –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: $canEdit, –£–¥–∞–ª–µ–Ω–∏–µ: $canDelete');
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
Future<void> checkBookingAccess(String userId, Car car, GlobalRole userRole) async {
  final canBook = await accessControl.canCreateBooking(userId, car, userRole);
  final canConfirm = await accessControl.canConfirmBooking(userId, car, userRole);
  
  print('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: $canBook, –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: $canConfirm');
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
Future<void> getUserCars(String userId, GlobalRole userRole) async {
  final cars = await accessControl.getAccessibleCars(userId, userRole);
  print('–î–æ—Å—Ç—É–ø–Ω–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π: ${cars.length}');
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã
Future<void> getUserRentals(String userId, GlobalRole userRole) async {
  final rentals = await accessControl.getAccessibleRentals(userId, userRole);
  print('–î–æ—Å—Ç—É–ø–Ω–æ –∞—Ä–µ–Ω–¥: ${rentals.length}');
}
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π

```dart
Future<void> migrateExistingCars() async {
  final firestore = FirebaseFirestore.instance;
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
  final carsSnapshot = await firestore.collection('cars').get();
  
  for (final doc in carsSnapshot.docs) {
    final data = doc.data();
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≥–∞—Ä–∞–∂–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ organizationId
    final organizationId = data['organization_id'];
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    final orgDoc = await firestore.collection('organizations').doc(organizationId).get();
    final directorId = orgDoc.data()?['director_user_id'];
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –≥–∞—Ä–∞–∂, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    final garageId = 'COMPANY_garage_$organizationId';
    final garageDoc = await firestore.collection('garages').doc(garageId).get();
    
    if (!garageDoc.exists) {
      final garage = CompanyGarage(
        id: garageId,
        name: '${orgDoc.data()?['name']} - –ê–≤—Ç–æ–ø–∞—Ä–∫',
        companyId: organizationId,
        directorId: directorId,
        createdAt: DateTime.now(),
        updatedAt: DateTime.now(),
      );
      
      await firestore.collection('garages').doc(garageId).set(garage.toFirestore());
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—å
    await firestore.collection('cars').doc(doc.id).update({
      'owner_id': organizationId,
      'garage_id': garageId,
      'garage_type': 'COMPANY',
      'company_id': organizationId,
    });
    
    print('–ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª—å: ${doc.id}');
  }
  
  print('–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
}
```

### –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∞—Ä–µ–Ω–¥

```dart
Future<void> migrateExistingRentals() async {
  final firestore = FirebaseFirestore.instance;
  
  final rentalsSnapshot = await firestore.collection('rentals').get();
  
  for (final doc in rentalsSnapshot.docs) {
    final data = doc.data();
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ
    final carId = data['car_id'];
    final carDoc = await firestore.collection('cars').doc(carId).get();
    final carData = carDoc.data()!;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–Ω—Å—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    final priceAmount = data['total_amount'] ?? data['price_amount'] ?? 0.0;
    final commissionAmount = data['commission_amount'] ?? 0.0;
    final ownerEarnings = priceAmount - commissionAmount;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ä–µ–Ω–¥—É
    await firestore.collection('rentals').doc(doc.id).update({
      'rental_user_id': data['manager_id'],
      'car_owner_id': carData['owner_id'],
      'managing_company_id': carData['company_id'],
      'price_amount': priceAmount,
      'owner_earnings': ownerEarnings,
    });
    
    print('–ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∞—Ä–µ–Ω–¥–∞: ${doc.id}');
  }
  
  print('–ú–∏–≥—Ä–∞—Ü–∏—è –∞—Ä–µ–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
}
```

---

## üìä –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞

```dart
Future<Map<String, dynamic>> getOwnerFinancials(String ownerId) async {
  final firestore = FirebaseFirestore.instance;
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞—Ä–µ–Ω–¥—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤–ª–∞–¥–µ–ª—å—Ü–∞
  final rentalsSnapshot = await firestore
      .collection('rentals')
      .where('car_owner_id', isEqualTo: ownerId)
      .where('status', whereIn: ['COMPLETED'])
      .get();
  
  double totalRevenue = 0;
  double totalCommissions = 0;
  double totalEarnings = 0;
  
  for (final doc in rentalsSnapshot.docs) {
    final data = doc.data();
    totalRevenue += (data['price_amount'] ?? 0.0).toDouble();
    totalCommissions += (data['commission_amount'] ?? 0.0).toDouble();
    totalEarnings += (data['owner_earnings'] ?? 0.0).toDouble();
  }
  
  return {
    'total_rentals': rentalsSnapshot.docs.length,
    'total_revenue': totalRevenue,
    'total_commissions': totalCommissions,
    'total_earnings': totalEarnings,
    'commission_rate': totalRevenue > 0 ? (totalCommissions / totalRevenue * 100) : 0,
  };
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞

```dart
Future<Map<String, dynamic>> getManagerStatistics(String managerId) async {
  final firestore = FirebaseFirestore.instance;
  
  final rentalsSnapshot = await firestore
      .collection('rentals')
      .where('rental_user_id', isEqualTo: managerId)
      .get();
  
  double totalCommissions = 0;
  int completedRentals = 0;
  
  for (final doc in rentalsSnapshot.docs) {
    final data = doc.data();
    if (data['status'] == 'COMPLETED') {
      completedRentals++;
      totalCommissions += (data['commission_amount'] ?? 0.0).toDouble();
    }
  }
  
  return {
    'total_rentals': rentalsSnapshot.docs.length,
    'completed_rentals': completedRentals,
    'total_commissions': totalCommissions,
  };
}
```

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é

1. **–ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è**: –ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –≥–∞—Ä–∞–∂–µ–π –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å –ø–æ–º–æ—â—å—é `AccessControl`
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI**: –ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
4. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è —Å –ø–æ–º–µ—Ç–∫–æ–π `@Deprecated`
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–π

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issues –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
